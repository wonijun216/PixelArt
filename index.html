<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>픽셀보드</title>
<style>
:root {
  --bg:#fff;
  --fg:#111;
  --muted:#666;
  --accent:#4f46e5;
}
html, body {
  height:100%;
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
  background:var(--bg);
  color:var(--fg);
}
.wrap {
  max-width:1200px;
  margin:0 auto;
  padding:16px;
}
header {
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  align-items:center;
  justify-content:space-between;
  margin:8px 0 12px;
}
h1 { font-size:20px;margin:0;font-weight:800; }
.muted { color:var(--muted); font-size:12px; }

.controls {
  display:flex;
  flex-wrap:wrap;
  gap:12px;
  align-items:center;
  margin:8px 0 16px;
}
.controls label { font-size:14px; color:var(--muted); }
.controls input[type="text"]{
  padding:12px 16px;
  border:1px solid #ddd;
  border-radius:12px;
  font-size:16px;
}
.controls input[type="color"]{ width:44px; height:36px; border:1px solid #ddd; border-radius:10px; padding:0; }
.controls input[type="color"]:disabled{ opacity:0.5; cursor:not-allowed; }

.btn {
  padding:12px 16px;
  border:1px solid #ddd;
  border-radius:12px;
  background:#fff;
  cursor:pointer;
  font-size:16px;
}
.btn.primary{ background:var(--accent); color:#fff; border-color:var(--accent); }

.boardContainer {
  display:flex;
  gap:16px;
  align-items:flex-start;
  flex-wrap:wrap;
}
.boardWrap {
  flex:1 1 400px;
  position:relative;
  border:1px solid #e5e7eb;
  border-radius:16px;
  padding:12px;
  background:#fff;
}
canvas{
  width:100%;
  height:auto;
  border-radius:8px;
  touch-action: manipulation;
}

.tip{ font-size:12px; color:var(--muted); margin-top:8px }
footer{ margin:16px 0; color:var(--muted); font-size:12px; display:flex; justify-content:space-between; align-items:center }

.pill{
  background:#f1f5f9;
  border:1px solid #e2e8f0;
  border-radius:999px;
  padding:4px 10px;
  font-size:12px;
}

.eraseMode { background:#f87171; color:#fff; border-color:#f87171; }
.hidden { display:none; }

#contributorsWrap {
  width:220px;
  border:1px solid #e5e7eb;
  border-radius:16px;
  background:#fff;
  padding:12px;
  flex-shrink:0;
}
#contributorsWrap h3 {
  font-size:14px;
  margin-top:0;
  margin-bottom:8px;
  font-weight:700;
}
#contributorsList {
  max-height:700px;
  overflow-y:auto;
  font-size:13px;
  line-height:1.5;
}
.contributor-item {
  display:flex;
  align-items:center;
  gap:8px;
  padding:4px 0;
  border-bottom:1px solid #f1f5f9;
}
.color-badge {
  width:16px;
  height:16px;
  border-radius:4px;
  border:1px solid #ddd;
  flex-shrink:0;
}

.color-locked-msg {
  font-size:12px;
  color:#ef4444;
  margin-top:4px;
}

@media (max-width: 768px) {
  .controls { flex-direction: column; gap:12px; }
  .boardContainer { flex-direction: column; align-items:center; }
  #contributorsWrap { width:100%; max-width:360px; margin-top:12px; }
}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>픽셀보드</h1>
    <div class="pill">보드: <span id="boardName">(로딩중)</span></div>
  </header>

  <div class="controls">
    <div>
      <label>닉네임</label><br/>
      <input id="nickname" type="text" placeholder="예: @joongdonghs" maxlength="12" />
    </div>
    <div>
      <label>색상</label><br/>
      <input id="picker" type="color" value="#a7f3d0" />
      <div id="colorLockedMsg" class="color-locked-msg hidden">색상이 고정되었습니다</div>
    </div>
    <button id="shareBtn" class="btn">링크 복사</button>
    <button id="newBoardBtn" class="btn">새 보드 만들기</button>
    <button id="eraseBtn" class="btn">지우개</button>
    <span class="muted">한 칸은 한 사람의 흔적입니다.</span>
  </div>

  <div class="boardContainer">
    <div class="boardWrap">
      <canvas id="board" width="768" height="768"></canvas>
      <div class="tip">빈칸을 클릭하거나 드래그해서 색칠하세요. 닉네임을 입력해야 기록됩니다.</div>
    </div>

    <div id="contributorsWrap">
      <h3>기여자 명단</h3>
      <div id="contributorsList">(로딩중)</div>
    </div>
  </div>

  <footer>
    <div>© <span id="y"></span> 중동고등학교 프로그래밍부</div>
  </footer>
</div>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
import { getFirestore, collection, doc, setDoc, onSnapshot, serverTimestamp, deleteDoc, getDocs, updateDoc } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

const firebaseConfig = {
  apiKey: "AIzaSyBjTIvP-E9KfZXFzuNE4sF9DmGzD4XkvEE",
  authDomain: "pixelart-e899e.firebaseapp.com",
  projectId: "pixelart-e899e",
  storageBucket: "pixelart-e899e.firebasestorage.app",
  messagingSenderId: "636347114408",
  appId: "1:636347114408:web:287e0ab9e7090f809a739d",
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const BOARD_SIZE = 64;
const canvas = document.getElementById('board');
const ctx = canvas.getContext('2d');
const nicknameEl = document.getElementById('nickname');
const colorEl = document.getElementById('picker');
const boardNameEl = document.getElementById('boardName');
const shareBtn = document.getElementById('shareBtn');
const newBoardBtn = document.getElementById('newBoardBtn');
const eraseBtn = document.getElementById('eraseBtn');
const contributorsList = document.getElementById('contributorsList');
const colorLockedMsg = document.getElementById('colorLockedMsg');
const $y = document.getElementById('y'); $y.textContent = new Date().getFullYear();

const params = new URLSearchParams(location.search);
const boardId = params.get('board') || '1';
boardNameEl.textContent = boardId;

let eraseMode = false;
let colorLocked = false;
let lockedColor = null;
let currentNickname = "";

// 고유 사용자 ID 생성 (브라우저 기반)
function getUserId() {
  let uid = localStorage.getItem('pixelboard_uid');
  if (!uid) {
    uid = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    localStorage.setItem('pixelboard_uid', uid);
  }
  return uid;
}

// 닉네임 변경 감지
nicknameEl.addEventListener("input", () => {
  const newNick = nicknameEl.value.trim();
  
  if (newNick !== currentNickname) {
    currentNickname = newNick;
    // 닉네임이 변경되면 색상 잠금 해제
    colorLocked = false;
    lockedColor = null;
    colorEl.disabled = false;
    colorLockedMsg.classList.add('hidden');
  }
});

// 공유 버튼
shareBtn.addEventListener('click', async ()=>{
  try{
    await navigator.clipboard.writeText(location.origin + location.pathname + `?board=${encodeURIComponent(boardId)}`);
    shareBtn.textContent='복사되었습니다';
    setTimeout(()=>shareBtn.textContent='링크 복사',1000);
  }catch(e){ alert('복사 실패'); }
});

// 새 보드 만들기
newBoardBtn.addEventListener('click', ()=>{
  const name = prompt('새 보드 이름 입력:', 'class1'); 
  if(!name) return;
  location.href = location.origin + location.pathname + `?board=${encodeURIComponent(name)}`;
});

// 그리드
function drawGrid(){ 
  const w=canvas.width,h=canvas.height; 
  ctx.clearRect(0,0,w,h); 
  ctx.fillStyle='#ffffff'; ctx.fillRect(0,0,w,h); 
  ctx.strokeStyle='#e5e7eb'; ctx.lineWidth=1; 
  const cell=w/BOARD_SIZE; ctx.beginPath(); 
  for(let i=0;i<=BOARD_SIZE;i++){ const p=Math.round(i*cell)+0.5; ctx.moveTo(p,0); ctx.lineTo(p,h); ctx.moveTo(0,p); ctx.lineTo(w,p);}
  ctx.stroke();
}

const cells = new Map();
function redrawCells(){ 
  const w=canvas.width, cell=w/BOARD_SIZE;
  for(const [key,data] of cells.entries()){
    ctx.fillStyle=data.color; 
    const [x,y]=key.split('_').map(Number);
    ctx.fillRect(x*cell+1,y*cell+1,cell-1,cell-1);
  }
}
function renderAll(){ drawGrid(); redrawCells(); }

const cellsCol = collection(db,'boards',boardId,'cells');
onSnapshot(cellsCol,snap=>{
  cells.clear();
  const contributorMap = new Map(); // nickname -> {color, timestamp}
  
  snap.forEach(doc=>{
    const d = doc.data();
    if(typeof d.x==='number' && typeof d.y==='number' && typeof d.color==='string'){
      cells.set(`${d.x}_${d.y}`, d);
      if(d.nickname && d.color) {
        const existing = contributorMap.get(d.nickname);
        const timestamp = d.updatedAt?.toMillis() || 0;
        if(!existing || timestamp > existing.timestamp) {
          contributorMap.set(d.nickname, {color: d.color, timestamp});
        }
      }
    }
  });
  
  renderAll();
  
  const sorted = Array.from(contributorMap.entries()).sort((a,b)=>b[1].timestamp - a[1].timestamp);
  contributorsList.innerHTML = sorted.length 
    ? sorted.map(([nick, data])=>`
        <div class="contributor-item">
          <div class="color-badge" style="background-color:${data.color}"></div>
          <span>${nick}</span>
        </div>
      `).join('') 
    : '<span class="muted">(없음)</span>';
});

// 셀 좌표 계산
function getCellFromEvent(evt){
  const rect=canvas.getBoundingClientRect();
  const scaleX=canvas.width/rect.width;
  const scaleY=canvas.height/rect.height;
  const clientX = (evt.touches?evt.touches[0].clientX:evt.clientX);
  const clientY = (evt.touches?evt.touches[0].clientY:evt.clientY);
  const x=Math.floor(((clientX-rect.left)*scaleX)/(canvas.width/BOARD_SIZE));
  const y=Math.floor(((clientY-rect.top)*scaleY)/(canvas.height/BOARD_SIZE));
  return {x,y};
}

// 셀 색칠/삭제
async function paintCell(x,y){
  const nick = nicknameEl.value.trim();
  if(!nick){ alert('닉네임을 입력하세요'); return; }
  if(x<0||y<0||x>=BOARD_SIZE||y>=BOARD_SIZE) return;
  
  const id = `${x}_${y}`;
  const ref = doc(db,'boards',boardId,'cells',id);
  const uid = getUserId();
  
  if(eraseMode){
    const cellData = cells.get(id);
    if(!cellData) return;
    if(cellData.nickname !== nick){
      alert("자신의 닉네임으로 색칠한 칸만 지울 수 있습니다");
      return;
    }
    await deleteDoc(ref);
    return;
  }
  
  // 이미 다른 사람이 색칠한 칸인지 확인
  const existingCell = cells.get(id);
  if(existingCell && existingCell.nickname !== nick) {
    alert("다른 사람이 이미 색칠한 칸입니다");
    return;
  }
  
  // 첫 색칠 시 색상 확인 후 고정
  if (!colorLocked) {
    const confirmColor = confirm(`이 색상(${colorEl.value})으로 결정하시겠습니까?\n한 번 색칠하면 색상을 변경할 수 없습니다.`);
    if(!confirmColor) return;
    
    colorLocked = true;
    lockedColor = colorEl.value;
    colorEl.disabled = true;
    colorLockedMsg.classList.remove('hidden');
  }
  
  await setDoc(ref,{ 
    x, y, 
    color: lockedColor, 
    nickname: nick, 
    uid: uid, 
    updatedAt: serverTimestamp() 
  });
}

eraseBtn.addEventListener('click', ()=>{
  eraseMode = !eraseMode;
  eraseBtn.classList.toggle('eraseMode', eraseMode);
  eraseBtn.textContent = eraseMode ? '지우개 ON' : '지우개';
});

// 클릭 + 드래그 색칠 지원
let isDrawing = false;
canvas.addEventListener('mousedown', e => { isDrawing=true; const {x,y}=getCellFromEvent(e); paintCell(x,y); });
canvas.addEventListener('mousemove', e => { if(!isDrawing) return; const {x,y}=getCellFromEvent(e); paintCell(x,y); });
canvas.addEventListener('mouseup', e => { isDrawing=false; });
canvas.addEventListener('mouseleave', e => { isDrawing=false; });

// 모바일 터치
canvas.addEventListener('touchstart', e=>{ isDrawing=true; const {x,y}=getCellFromEvent(e); paintCell(x,y); e.preventDefault(); },{passive:false});
canvas.addEventListener('touchmove', e=>{ if(!isDrawing) return; const {x,y}=getCellFromEvent(e); paintCell(x,y); e.preventDefault(); },{passive:false});
canvas.addEventListener('touchend', e=>{ isDrawing=false; },{passive:false});

renderAll();
</script>
</body>
</html>
